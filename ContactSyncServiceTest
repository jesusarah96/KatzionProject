@IsTest
private class ContactSyncServiceTest {
    
    @testSetup
    private static void createSampleContacts() {
        List<Contact> contacts = new List<Contact>();
        for (Integer i = 0; i < 10; i++) {
            contacts.add(new Contact(
                FirstName = 'Test' + i,
                LastName  = 'Contact' + i,
                Email     = 'test' + i + '@example.com',
                Phone     = '999999999' + i
            ));
        }
    }
    
    @IsTest
    static void testSyncContacts_Success() {
        List<Contact> contacts = [SELECT Id, FirstName, LastName, Email, Phone FROM Contact LIMIT 10];
        String requestBody = JSON.serialize(contacts);
        
        RestRequest req = new RestRequest();
        RestResponse res = new RestResponse();
        
        req.requestUri = '/services/apexrest/contactSync';
        req.httpMethod = 'POST';
        req.requestBody = Blob.valueOf(requestBody);
        RestContext.request = req;
        RestContext.response = res;
        
        Test.startTest();
        String result = ContactSyncService.syncContacts(contacts);
        Test.stopTest();
        
        System.assertEquals('Success', result, 'Expected successful contact sync');
    }
    
    @IsTest
    static void testSyncContacts_Failure() {
        List<Contact> badContacts = new List<Contact>{
            new Contact(FirstName = 'NoLastName', Email = 'fail@example.com')
        };
        
        String requestBody = JSON.serialize(badContacts);
        RestRequest req = new RestRequest();
        RestResponse res = new RestResponse();
        
        req.requestUri = '/services/apexrest/contactSync';
        req.httpMethod = 'POST';
        req.requestBody = Blob.valueOf(requestBody);
        RestContext.request = req;
        RestContext.response = res;
        
        Test.startTest();
        String result = ContactSyncService.syncContacts(badContacts);
        Test.stopTest();
        
        System.assert(result.startsWith('Error:'), 'Expected error response when insert fails');
    }
    
    @IsTest
    static void testSyncContacts_EmptyList() {
        List<Contact> emptyList = new List<Contact>();
        
        RestRequest req = new RestRequest();
        RestResponse res = new RestResponse();
        req.requestUri = '/services/apexrest/contactSync';
        req.httpMethod = 'POST';
        req.requestBody = Blob.valueOf(JSON.serialize(emptyList));
        RestContext.request = req;
        RestContext.response = res;
        
        Test.startTest();
        String result = ContactSyncService.syncContacts(emptyList);
        Test.stopTest();
        
        System.assertEquals('Success', result, 'Inserting empty list should not fail');
    }
}
